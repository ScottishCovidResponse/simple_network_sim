import random

import pytest

from simple_network_sim import covidAdapted as ss
from simple_network_sim import loaders


def test_basic_simulation(age_transitions, demographics, commute_moves, compartment_names, age_infection_matrix):
    age_to_trans = ss.setUpParametersAges(loaders.readParametersAgeStructured(age_transitions))
    population = loaders.readPopulationAgeStructured(demographics)
    graph = loaders.genGraphFromContactFile(commute_moves)
    states = ss.setupInternalPopulations(graph, compartment_names, list(age_to_trans.keys()), population)

    result = ss.basicSimulationInternalAgeStructure(
        rand=random.Random(1),
        graph=graph,
        numInfected=10,
        timeHorizon=200,
        genericInfection=0.1,
        ageInfectionMatrix=age_infection_matrix,
        diseaseProgressionProbs=age_to_trans,
        dictOfStates=states,
    )

    expected = [
        0,
        4.27,
        5.959639,
        7.495598979703686,
        9.31292448442533,
        11.550960285080539,
        14.32076069530553,
        17.750346856443436,
        21.996595859880493,
        27.253215606191763,
        33.75958029276324,
        41.81147883471944,
        51.77434261313086,
        64.09953959129047,
        79.34443722167374,
        98.19708895391234,
        121.5065842268399,
        150.32032333168627,
        185.92974139403356,
        229.92631464707316,
        284.27004075722795,
        351.3729944719362,
        434.2010173334121,
        536.3970957055917,
        662.4304939975676,
        817.7762023518806,
        1009.1296689642635,
        1244.6620222362512,
        1534.3209088397605,
        1890.1814875375615,
        2326.8507704591293,
        2861.926080186407,
        3516.5045468063877,
        4315.734994514654,
        5289.3961276280115,
        6472.475902589639,
        7905.717433786824,
        9636.08906655341,
        11717.13446074682,
        14209.16871256282,
        17179.315999723975,
        20701.439040274323,
        24856.09052908778,
        29730.707243910434,
        35420.33217223618,
        42029.128554931965,
        49672.773024855385,
        58481.44396269627,
        68602.60309097261,
        80202.27853153124,
        93463.37789059673,
        108579.96624726593,
        125747.53880875603,
        145150.90161910592,
        166952.82966413427,
        191287.47020551964,
        218261.74745540041,
        247965.3261465324,
        280485.2367071461,
        315916.38015373435,
        354356.14564567205,
        395872.69490304653,
        440443.1364258809,
        487868.5388265991,
        537684.1860953799,
        589091.5046792259,
        640938.9095905811,
        691769.9762481726,
        739939.1843065555,
        783772.9904113912,
        821736.8679191938,
        852567.1996643285,
        875343.2246963251,
        889499.9704796937,
        894803.485637448,
        891314.7525319818,
        879359.4394061461,
        859505.977536541,
        832543.5198251844,
        799448.8236543302,
        761336.2708291251,
        719393.6436135583,
        674812.7866198674,
        628726.0228195366,
        582156.5631853839,
        535986.5646189475,
        490942.3244969345,
        447593.5332414354,
        406362.5717409869,
        367540.01510870096,
        331303.2145504978,
        297735.6728639047,
        266845.6949524783,
        238583.40447859198,
        212855.66475276518,
        189538.74944848128,
        168488.80761225612,
        149550.28647197766,
        132562.53827530914,
        117364.86191178164,
        103800.22980549172,
        91717.93520231653,
        80975.37134265121,
        71439.12677319416,
        62985.553271939556,
        55500.93643588842,
        48881.374979513224,
        43032.45371205615,
        37868.777124977256,
        33313.415413891256,
        29297.302334462536,
        25758.61423633403,
        22642.151601387908,
        19898.738109895345,
        17484.64737342592,
        15361.063743396788,
        13493.580801682876,
        11851.739073032668,
        10408.603009095552,
        9140.37625068078,
        8026.053473547509,
        7047.106679898116,
        6187.203546762776,
        5431.955332005772,
        4768.691828813375,
        4186.260919647075,
        3674.8503875840925,
        3225.8297793633656,
        2831.6102674926847,
        2485.5206191429197,
        2181.697540636489,
        1914.9888235502897,
        1680.8678687529227,
        1475.3583061787265,
        1294.9675597411838,
        1136.6283280441162,
        997.6470624276589,
        875.6586246476982,
        768.5863975872606,
        674.6072044116167,
        592.1204651473781,
        519.721085459352,
        456.1756310875024,
        400.40139364220994,
        351.44799986096695,
        308.4812575877343,
        270.76896818966605,
        237.66846737351318,
        208.61568486118352,
        183.11553854396615,
        160.73350093111426,
        141.08819527652577,
        123.8448960080496,
        108.70982326635439,
        95.42513472402354,
        83.76452961376395,
        73.52939023666997,
        64.54539531517312,
        56.65954754922215,
        49.73756475976603,
        43.66159017682611,
        38.328182852791116,
        33.64655394541582,
        29.537018798984292,
        25.929638426375362,
        22.763027221103627,
        19.98330656117008,
        17.54318645356159,
        15.401159551545785,
        13.520793793496033,
        11.870111594347737,
        10.42104499749586,
        9.148957491085977,
        8.032224330272163,
        7.051864205475331,
        6.191215972979529,
        5.435654933281273,
        4.7723438175693484,
        4.1900142350687,
        3.678774853837169,
        3.2299430438278187,
        2.835897111408885,
        2.4899466059017845,
        2.186218487054244,
        1.9195572129748524,
        1.6854370455381997,
        1.4798850786813753,
        1.29941367791204,
        1.1409611798590402,
        1.001839841559402,
        0.8796901527963475,
        0.772440733292397,
        0.6782731317724259,
        0.5955909274692558,
        0.5229926079757407,
        0.45924776170425224,
        0.40327617969564616,
        0.35412951108933594,
        0.3109751600700831,
        0.2730821502880063,
    ]

    assert result == pytest.approx(expected)


def test_basic_simulation_100_runs(
    age_transitions, demographics, commute_moves, compartment_names, age_infection_matrix
):
    age_to_trans = ss.setUpParametersAges(loaders.readParametersAgeStructured(age_transitions))
    population = loaders.readPopulationAgeStructured(demographics)
    graph = loaders.genGraphFromContactFile(commute_moves)
    states = ss.setupInternalPopulations(graph, compartment_names, list(age_to_trans.keys()), population)

    runs = []
    rand = random.Random(1)
    for _ in range(100):
        runs.append(
            ss.basicSimulationInternalAgeStructure(
                rand=rand,
                graph=graph,
                numInfected=10,
                timeHorizon=200,
                genericInfection=0.1,
                ageInfectionMatrix=age_infection_matrix,
                diseaseProgressionProbs=age_to_trans,
                dictOfStates=states,
            )
        )
    result = ss.generateMeanPlot(runs)

    expected = [
        0.0,
        50.59949999999987,
        70.62172215000008,
        88.53907640948805,
        109.56585961112921,
        135.34781662864572,
        167.14909371433808,
        206.40676106524504,
        254.87441418690946,
        314.7127609678122,
        388.58739459060615,
        479.7869769364914,
        592.3683441661985,
        731.3349381218054,
        902.8561092307385,
        1114.5364037922002,
        1375.745840337323,
        1698.0244089346736,
        2095.576618086404,
        2585.874879171037,
        3190.3938468831866,
        3935.5014751766903,
        4853.5363927226745,
        5984.105058459843,
        7375.635725149071,
        9087.229076006823,
        11190.846895762064,
        13773.879480398624,
        16942.12861838295,
        20823.234477669143,
        25570.55958626985,
        31367.518073304207,
        38432.29778213175,
        47022.85650028178,
        57441.9632519079,
        70041.87188060116,
        85227.9148171674,
        103459.84083861802,
        125249.05533307492,
        151149.07006915603,
        181735.5536527572,
        217571.67989449936,
        259154.48194133703,
        306839.29038240714,
        360742.774888453,
        420631.1277806328,
        485808.35379895894,
        555028.942592134,
        626465.9515280168,
        697764.6181370248,
        766198.3683990123,
        828918.0908387898,
        883254.1476689971,
        927007.8281468125,
        958667.9440776533,
        977511.4835765692,
        983583.4240229285,
        977582.5790045436,
        960695.7862877236,
        934420.8988117075,
        900406.8701049259,
        860325.0426850033,
        815774.8385927199,
        768220.8707329235,
        718956.0607168003,
        669085.01764655,
        619522.4535519959,
        571002.1422746733,
        524092.6365698418,
        479216.6189182476,
        436671.4360761342,
        396649.09680846095,
        359254.7442078685,
        324523.2206974168,
        292433.71662884555,
        262922.6231226694,
        235894.68385686324,
        211232.4752411027,
        188804.22098854627,
        168469.99004745498,
        150086.41468721823,
        133510.15349605007,
        118600.37113138009,
        105220.49751745356,
        93239.47779203352,
        82532.65886548218,
        72982.40243608662,
        64478.4775375168,
        56918.26669640287,
        50206.81231822483,
        44256.727974709764,
        38987.99892432725,
        34327.695586414215,
        30209.622246147293,
        26573.921066060393,
        23366.648808437272,
        20539.340827992262,
        18048.574104704425,
        15855.538502413805,
        13925.623143259334,
        12228.022816026823,
        10735.367690163155,
        9423.378268495051,
        8270.546451007458,
        7257.842764498291,
        6368.4492023174835,
        5587.5166798032415,
        4901.945812324021,
        4300.189535518351,
        3772.0759867856773,
        3308.6500325769557,
        2902.0318404198833,
        2545.2909440111757,
        2232.334323053546,
        1957.8071081745998,
        1717.0046186072154,
        1505.7945413594405,
        1320.5481617079922,
        1158.0796534173924,
        1015.5925313479725,
        890.6324579322089,
        781.0456777151343,
        684.942430468233,
        600.6647632566685,
        526.7582254054128,
        461.94698783514747,
        405.11198006633987,
        355.27168470800154,
        311.56527086675186,
        273.23778504550415,
        239.6271511550904,
        210.1527606248168,
        184.305459636107,
        161.63876355845153,
        141.7611490538984,
        124.32929232353086,
        109.04213785894086,
        95.63569607052423,
        83.87848050600661,
        73.5675062381869,
        64.5247805616761,
        56.594225546862056,
        49.63897939120884,
        43.539030003761106,
        38.18913996512339,
        33.49702701676344,
        29.38176863371192,
        25.772403097402453,
        22.606702875497803,
        19.830099090468565,
        17.394738468862535,
        15.258656453104361,
        13.385052166362811,
        11.741652682904785,
        10.300155601611582,
        9.035740275529745,
        7.92663923875464,
        6.953762414088654,
        6.100367598736816,
        5.351771526579395,
        4.695096508131962,
        4.119048265316115,
        3.613721118270106,
        3.1704271549768195,
        2.781546429673179,
        2.4403956000190785,
        2.1411127321536494,
        1.8785562825766595,
        1.6482165111153821,
        1.4461377943216782,
        1.2688504972175898,
        1.1133112266398941,
        0.9768504343887103,
        0.8571264654755679,
        0.7520852581942783,
        0.6599250004347045,
        0.5790651323174966,
        0.5081191603316926,
        0.4458708140074494,
        0.3912531338939087,
        0.34333013023710174,
        0.30128069614198544,
        0.2643844979241177,
        0.23200959948450423,
        0.20360160746623626,
        0.17867415019152041,
        0.15680052638688358,
        0.13760637988053642,
        0.12076327414820837,
        0.10598305609822323,
        0.09301291209136163,
        0.08163103112141497,
        0.0716428005444676,
        0.06287746891962855,
        0.055185218569769476,
        0.04843459752670753,
        0.04251026671314731,
        0.03731102364039392,
        0.032748068660046606,
        0.028743483981754688,
    ]

    assert result == pytest.approx(expected)
